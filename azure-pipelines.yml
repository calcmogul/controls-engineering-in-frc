jobs:
- job: Compilation
  pool:
    vmImage: 'Ubuntu 16.04'

  steps:
  - task: UsePythonVersion@0
    inputs:
      versionSpec: '3.6'
      architecture: 'x64'
  - script: |
      sudo apt-get update -y
      sudo apt-get install -y latexmk texlive-xetex texlive-latex-extra \
          texlive-generic-extra texlive-bibtex-extra biber gfortran \
          libblas-dev liblapack-dev cmake inkscape ghostscript
    displayName: 'Install system dependencies'
  - script: |
      pip3 install --user frccontrol black slycot
    displayName: 'Install Python packages'
  - script: |
      ./format_code.py
    displayName: 'Run Python formatter'
  - script: |
      git --no-pager diff --exit-code HEAD  # Ensure formatter made no changes
    displayName: 'Check formatter output'
  - script: |
      # Make sure .git/refs/heads/master exists
      git checkout -b pr
      git checkout master
      git checkout pr

      make -j$(nproc) ebook
      cp state-space-guide-ebook.pdf $(Build.ArtifactStagingDirectory)/state-space-guide.pdf
    displayName: 'Generate PDF'
  - script: |
      # This check script is run after the book build so that any included .tex
      # files that are generated by the build exist.
      ./check_tex_includes.py
    displayName: 'Check .tex file includes'
  - task: PublishBuildArtifacts@1
    inputs:
      pathtoPublish: '$(Build.ArtifactStagingDirectory)'
      artifactName: state-space-guide.pdf
